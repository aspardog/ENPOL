load(paste0(path2DB,"/National/Data_cleaning/Output/Main_database.RData")) 


master_data.df <- Main_database  %>%
  filter(Anio_arresto >= 2018, NSJP == 1) %>%
  mutate(FAC_PER = as.numeric(FAC_PER)) %>%
  mutate(tortura_psi = case_when(tortura_tra_p == 1 ~ 1,
                                 tortura_mp_p == 1 ~ 1,
                                 tortura_tra_p == 0 ~ 0,
                                 tortura_mp_p == 0 ~ 0,
                                 T ~ NA_real_),
         tortura_fis = case_when(tortura_tra_f == 1 ~ 1,
                                 tortura_mp_f == 1 ~ 1,
                                 tortura_tra_f == 0 ~ 0,
                                 tortura_mp_f == 0 ~ 0,
                                 T ~ NA_real_),
         PJ_1a = case_when(P5_22_02 == 2 ~ 0,
                          P5_22_02 == 1 ~ 1,
                          T ~ NA_real_),
         PJ_2a = case_when(P5_22_01 == 2 ~ 0,
                          P5_22_01 == 1 ~ 1,
                          T ~ NA_real_),
         PJ_3a = case_when(P4_7 == "04" | P4_7 == "05" ~ 0,
                          (P4_4 == "2" & P4_5 == "2") ~ 1,
                          P4_6_4 == 1 & (is.na(P4_7) == T | (P4_7 != "04" & P4_7 != "05")) ~ 1,
                          P4_6_4 == 0 ~ 1,
                          T ~ NA_real_),
         PJ_4a = case_when(P4_1_05 == "2" ~ 0,
                          P4_1_05 == "1" ~ 1,
                          T ~ NA_real_),
         PJ_5a = case_when(P5_20_2 == 1 | P5_20_1 == 1 ~ 0,
                          P5_20_2 == 2 & P5_20_1 == 2 ~ 1,
                          T ~ NA_real_),
         PJ_6a = case_when((P3_20 == "06" | P3_20 == "07" | P3_20 == "08" | P3_20 == "09") &
                            (P3_17_08 == 1 | (is.na(P3_17_08) == T | (P3_19 != "01" & P3_19 != "02" & P3_19 !="03" & P3_19 !="13"))) ~ 0,
                          (P3_20 == "06" | P3_20 == "07" | P3_20 == "08" | P3_20 == "09") & 
                            (is.na(P3_17_08) == T | P3_17_08 != 1) & (P3_19 == "01" | P3_19 == "02" | P3_19 =="03" | P3_19 !="13") ~ 1,
                          P3_20 == "01" | P3_20 == "02" | P3_20 == "03" | P3_20 == "04" | P3_20 == "05" ~ 1,
                          T ~ NA_real_),
         PJ_7a = case_when(P5_16_2 == 2 | P5_16_2 == 3| P5_16_2 == 4 ~ 0,
                          P5_16_2 == 1  ~ 1,
                          T ~ NA_real_),
         UAA_1a = case_when(proporcionalidad_uso_fuerza == 1 ~ 1,
                           proporcionalidad_uso_fuerza == 0 ~ 0,
                           T ~ NA_real_),
         UAA_2a = case_when(P3_21_1 == 1 | P3_21_2 == 1 ~ 0,
                           (P3_21_1 == 2 & P3_21_2 == 2) | (is.na(P3_21_1) == T & P3_21_2 == 2) | (P3_21_1 == 2 & is.na(P3_21_2) == T) ~ 1,
                           T ~ NA_real_),
         UAA_3a = case_when(P4_15_1 == 1 | P4_15_3 == 1 ~ 0,
                           (P4_15_1 == 2 & P4_15_3 == 2) | (is.na(P4_15_1) == T & P4_15_3 == 2) | (P4_15_1 == 2 & is.na(P4_15_3) == T) ~ 1,
                           T ~ NA_real_),
         UAA_4a = case_when(P5_45_1 == 1 | P5_45_3 == 1 ~ 0,
                           (P5_45_1 == 2 & P5_45_3 == 2) | (is.na(P5_45_1) == T & P5_45_3 == 2) | (P5_45_1 == 2 & is.na(P5_45_3) == T) ~ 1,
                           T ~ NA_real_),
         GDH_1a = case_when(tortura_generalizada == 1 ~ 0,
                           tortura_generalizada == 0 ~ 1,
                           T ~ NA_real_),
         GDH_2a = case_when(det_ninguna == 1 ~ 0,
                           det_ninguna == 0 ~ 1,
                           T ~ NA_real_)) %>%
  mutate( 
    PJ_1a = case_when(
      sentenciado == 1 ~ PJ_1,
      T ~ NA_real_),
    PJ_2a = case_when(
      sentenciado == 1 ~ PJ_2,
      T ~ NA_real_),
    PJ_3a = case_when(
      sentenciado == 1 ~ PJ_3,
      T ~ NA_real_),
    PJ_4a = case_when(
      sentenciado == 1 ~ PJ_4,
      T ~ NA_real_),
    PJ_5a = case_when(
      sentenciado == 1 ~ PJ_5,
      T ~ NA_real_),
    PJ_6a = case_when(
      sentenciado == 1 ~ PJ_6,
      T ~ NA_real_),
    PJ_7a = case_when(
      sentenciado == 1 ~ PJ_7,
      T ~ NA_real_),
    UAA_1a = case_when(
      sentenciado == 1 ~ UAA_1,
      T ~ NA_real_),
    UAA_2a = case_when(
      sentenciado == 1 ~ UAA_2,
      T ~ NA_real_),
    UAA_3a = case_when(
      sentenciado == 1 ~ UAA_3,
      T ~ NA_real_),
    UAA_4a = case_when(
      sentenciado == 1 ~ UAA_4,
      T ~ NA_real_),
    GDH_1a = case_when(
      sentenciado == 1 ~ GDH_1,
      T ~ NA_real_),
    GDH_2a = case_when(
      sentenciado == 1 ~ GDH_2,
      T ~ NA_real_))%>%
  rowwise() %>% 
  mutate(indicator_general = mean(c_across(c(GDH_1a, GDH_2a,
                                             UAA_1a, UAA_2a, UAA_3a, UAA_4a,
                                             PJ_1a, PJ_2a,PJ_3a,PJ_4a,PJ_5a,PJ_6a,PJ_7a)), na.rm = TRUE),
         indicator_general = round(indicator_general, 1))


data_subset.df <- master_data.df %>% 
  mutate(
    `1a` = case_when(indicator_general == 1 ~ 1,
                     indicator_general < 1 ~ 0,
                     T ~ NA_real_),
    `2a` = case_when(P5_26A == 1 ~ 1,
                     P5_26A == 0 ~ 0,
                     T ~ NA_real_),
    `3a` = case_when(P5_26B == "1" ~ 1,
                     P5_26B == "2" ~ 1,
                     P5_26B == "3" ~ 0,
                     P5_26B == "4" ~ 0,
                     T ~ NA_real_),
    `4a` = case_when(P3_1 == "1" ~ 0,
                     P3_1 == "2" ~ 0,
                     P3_1 == "3" ~ 1,
                     P3_1 == "4" ~ 1,
                     T ~ NA),
    `5.1a` = case_when(P3_14_4 == 1  ~ 1,
                       P3_14_4 == 0  ~ 0,
               T ~ NA_real_),
    `5.2a` = case_when(P4_1_03 == "1"  ~ 1,
                       P4_1_03 == "2"  ~ 0,
                       T ~ NA_real_),
    `5.3a` = case_when(P5_2_1 == "1"  ~ 1,
                       P5_2_1 == "2"  ~ 0,
                       T ~ NA_real_),
    `6.1a` = case_when(P3_14_5 == 1  ~ 1,
                       P3_14_5 == 0  ~ 0,
                       T ~ NA_real_),
    `6.2a` = case_when(P4_1_04 == "1"  ~ 1,
                       P4_1_04 == "2"  ~ 0,
                       T ~ NA_real_),
    `6.3a` = case_when(P5_2_4 == "1"  ~ 1,
                       P5_2_4 == "2"  ~ 0,
                       T ~ NA_real_),
    `7.1a` = case_when(P4_1_05 == "1"  ~ 1,
                       P4_1_05 == "2"  ~ 0,
                       T ~ NA_real_),
    `7.2a` = case_when(P5_2_5 == "1" ~ 1,
                       P5_2_5 == "2" ~ 0,
                       T ~ NA_real_),
    `8.1a` = case_when(P5_24_1 == "1" | P5_44_1 == "1"   ~ 1,
                       P5_24_1 == "2" | P5_44_1 == "2"   ~ 1,
                       P5_24_1 == "3" | P5_44_1 == "3"   ~ 0,
                       P5_24_1 == "4" | P5_44_1 == "4"   ~ 0,
                       T ~ NA_real_),
    `8.2a` = case_when(P5_24_2 == "1" | P5_44_2 == "1"   ~ 1,
                       P5_24_2 == "2" | P5_44_2 == "2"   ~ 1,
                       P5_24_2 == "3" | P5_44_2 == "3"   ~ 0,
                       P5_24_2 == "4" | P5_44_2 == "4"   ~ 0,
                       T ~ NA_real_),
    `9.1a` = case_when(P3_20 == "01" ~ 1,
                       P3_20 == "02" ~ 1,
                       P3_20 == "03" ~ 1,
                       P3_20 == "04" ~ 1,
                       P3_20 == "05" ~ 0,
                       P3_20 == "06" ~ 0,
                       P3_20 == "07" ~ 0,
                       P3_20 == "08" ~ 0,
                       P3_20 == "09" ~ 0,
                       T ~ NA_real_),
    `9.2a` = case_when(P3_20 == "01" ~ 0,
                       P3_20 == "02" ~ 0,
                       P3_20 == "03" ~ 0,
                       P3_20 == "04" ~ 0,
                       P3_20 == "05" ~ 1,
                       P3_20 == "06" ~ 1,
                       P3_20 == "07" ~ 0,
                       P3_20 == "08" ~ 0,
                       P3_20 == "09" ~ 0,
                       T ~ NA_real_),
    `10.1a` = case_when(P3_19 == "01" ~ 1,
                        P3_19 == "02" ~ 0,
                        P3_19 == "03" ~ 0,
                        P3_19 == "04" ~ 0,
                        P3_19 == "05" ~ 0,
                        P3_19 == "06" ~ 0,
                        P3_19 == "07" ~ 0,
                        P3_19 == "08" ~ 0,
                        P3_19 == "09" ~ 0,
                        P3_19 == "10" ~ 0,
                        P3_19 == "11" ~ 0,
                        P3_19 == "12" ~ 0,
                        P3_19 == "13" ~ 0,
                        P3_19 == "14" ~ 0,
                       T ~ NA_real_),
    `10.2a` = case_when(P3_19 == "01" ~ 0,
                        P3_19 == "02" ~ 0,
                        P3_19 == "03" ~ 1,
                        P3_19 == "04" ~ 0,
                        P3_19 == "05" ~ 0,
                        P3_19 == "06" ~ 0,
                        P3_19 == "07" ~ 0,
                        P3_19 == "08" ~ 0,
                        P3_19 == "09" ~ 0,
                        P3_19 == "10" ~ 0,
                        P3_19 == "11" ~ 0,
                        P3_19 == "12" ~ 0,
                        P3_19 == "13" ~ 0,
                        P3_19 == "14" ~ 0,
                        T ~ NA_real_),
    `11.1a` = case_when(P5_16_2 == "1" | P5_36_2 == "1" ~ 1,
                        P5_16_2 == "2" | P5_36_2 == "2" ~ 0,
                        P5_16_2 == "3" | P5_36_2 == "3" ~ 0,
                        P5_16_2 == "4" | P5_36_2 == "4" ~ 0,
                       T ~ NA_real_), 
    `11.2a` = case_when(P5_19_3 == "1" | P5_39_3 == "1" ~ 1,
                        P5_19_3 == "2" | P5_39_3 == "2" ~ 0,
                        T ~ NA_real_), 
    `11.3a` = case_when(P5_16_5 == "1" | P5_36_5 == "1" ~ 1,
                        P5_16_5 == "2" | P5_36_5 == "2" ~ 0,
                        P5_16_5 == "3" | P5_36_5 == "3" ~ 0,
                        P5_16_5 == "4" | P5_36_5 == "4" ~ 0,
                        T ~ NA_real_),
    `11.4a` = case_when(P5_25 == "1" ~ 0,
                        P5_25 == "2" ~ 1,
                        T ~ NA_real_),
    `11.5a` = case_when(P5_17_2 == "1" | P5_37_2 == "1" ~ 1,
                        P5_17_2 == "2" | P5_37_2 == "2"  ~ 1,
                        P5_17_2 == "3" | P5_37_2 == "3"  ~ 1,
                        P5_17_2 == "4" | P5_37_2 == "4"  ~ 0,
                        T ~ NA_real_),
    `11.6a` = case_when(P5_26 == "1" ~ 1,
                        P5_26 == "2" ~ 1,
                        P5_26 == "3" ~ 0,
                        P5_26 == "4" ~ 0,
                        T ~ NA_real_),
    `12.1a` = case_when(P5_10 == "1" ~ 1,
                        P5_10 == "2" ~ 1,
                        P5_10 == "3" ~ 1,
                        P5_10 == "4" ~ 1,
                        P5_10 == "5" ~ 0,
                        P5_10 == "6" ~ 0,
                        P5_10 == "7" ~ 0,
                        T ~ NA_real_),
    `12.2a` = case_when(P5_10 == "1" ~ 0,
                        P5_10 == "2" ~ 0,
                        P5_10 == "3" ~ 0,
                        P5_10 == "4" ~ 0,
                        P5_10 == "5" ~ 1,
                        P5_10 == "6" ~ 0,
                        P5_10 == "7" ~ 0,
                        T ~ NA_real_),
    `12.3a` = case_when(P5_10 == "1" ~ 0,
                        P5_10 == "2" ~ 0,
                        P5_10 == "3" ~ 0,
                        P5_10 == "4" ~ 0,
                        P5_10 == "5" ~ 0,
                        P5_10 == "6" ~ 1,
                        P5_10 == "7" ~ 0,
                        T ~ NA_real_),
    `12.4a` = case_when(P5_10 == "1" ~ 0,
                        P5_10 == "2" ~ 0,
                        P5_10 == "3" ~ 0,
                        P5_10 == "4" ~ 0,
                        P5_10 == "5" ~ 0,
                        P5_10 == "6" ~ 0,
                        P5_10 == "7" ~ 1,
                        T ~ NA_real_),
    `13.1a` = case_when(P3_2 == "01" & proporcionalidad_uso_fuerza == 1 ~ 1,
                        P3_2 == "01" & proporcionalidad_uso_fuerza == 0 ~ 0,
                        T ~ NA_real_),
    `13.2a` = case_when(P3_2 == "02" & proporcionalidad_uso_fuerza == 1 ~ 1,
                        P3_2 == "02" & proporcionalidad_uso_fuerza == 0 ~ 0,
                        T ~ NA_real_),
    `13.3a` = case_when(P3_2 == "04" & proporcionalidad_uso_fuerza == 1 ~ 1,
                        P3_2 == "04" & proporcionalidad_uso_fuerza == 0 ~ 0,
                        T ~ NA_real_),
    `13.4a` = case_when(P3_2 == "09" & proporcionalidad_uso_fuerza == 1 ~ 1,
                        P3_2 == "09" & proporcionalidad_uso_fuerza == 0 ~ 0,
                        T ~ NA_real_),
    `13.5a` = case_when((P3_2 == "03" | P3_2 == "06") & proporcionalidad_uso_fuerza == 1 ~ 1,
                        (P3_2 == "03" | P3_2 == "06") & proporcionalidad_uso_fuerza == 0 ~ 0,
                        T ~ NA_real_),
    `13.6a` = case_when(P3_2 == "05" & proporcionalidad_uso_fuerza == 1 ~ 1,
                        P3_2 == "05" & proporcionalidad_uso_fuerza == 0 ~ 0,
                        T ~ NA_real_),
    `13.7a` = case_when((P3_2 == "07" | P3_2 == "08") & proporcionalidad_uso_fuerza == 1 ~ 1,
                        (P3_2 == "07" | P3_2 == "08") & proporcionalidad_uso_fuerza == 0 ~ 0,
                        T ~ NA_real_),
    `14.1a` = case_when(tortura_tra == 1 ~ 1,
                        tortura_tra == 0 ~ 0,
                        T ~ NA_real_),
    `14.2a` = case_when(tortura_mp == 1 ~ 1,
                        tortura_mp == 0 ~ 0,
                        T ~ NA_real_),
    `15.1a` = case_when(RND_3 == 1 ~ 1,
                        RND_3 == 0 ~ 0,
                        T ~ NA_real_),
    `15.2a` = case_when(RND_3 == 1 ~ 1,
                        RND_3 == 0 ~ 0,
                        T ~ NA_real_),
    `16.1a` = case_when(procesado == 1 ~ 1,
                        procesado == 0 ~ 0,
                        T ~ NA_real_),
    `16.2a` = case_when(sentenciado == 1 ~ 1,
                        sentenciado == 0 ~ 0,
                        T ~ NA_real_),
    `17.1a` = case_when(tipo_prision_preventiva == "Prisión Preventiva Oficiosa" ~ 1,
                        tipo_prision_preventiva == "Prisión Preventiva Justificada" ~ 0,
                        T ~ NA_real_),
    `17.2a` = case_when(tipo_prision_preventiva == "Prisión Preventiva Oficiosa" ~ 0,
                        tipo_prision_preventiva == "Prisión Preventiva Justificada" ~ 1,
                        T ~ NA_real_)) %>%
  select(Estado_arresto, `1a`, `2a`, `3a`, `4a`, `5.1a`, `5.2a`, `5.3a`, `6.1a`, `6.2a`, `6.3a`, `7.1a`,`7.2a`, `8.1a`, `8.2a`, 
         `9.1a`, `9.2a`, `10.1a`, `10.2a`, `11.1a`, `11.2a`, `11.3a`, `11.4a`, `11.5a`, `11.6a`, `12.1a`, `12.2a`, `12.3a`,  `12.4a`,
         `13.1a`, `13.2a`, `13.3a`, `13.4a`, `13.5a`, `13.6a`, `13.7a`, `14.1a`, `14.2a`, `15.1a`, `15.2a`, `16.1a`, `16.2a`, 
         `17.1a`, `17.2a`, PJ_1a, PJ_2a, PJ_3a, PJ_4a, PJ_5a, PJ_6a, PJ_7a, UAA_1a, UAA_2a, UAA_3a, UAA_4a, GDH_1a, GDH_2a) 



cambio_tort_p <- master_data.df %>% mutate(Estado = "Promedio Nacional") %>% filter(as.numeric(years_since_RND_3) < 2 & as.numeric(years_since_RND_3) > -2 ) %>% group_by(Estado,RND_3) %>% summarise(tortura_p = mean(tortura_psi, na.rm = T))
cambio_tort_f <- master_data.df %>% mutate(Estado = "Promedio Nacional") %>% filter(as.numeric(years_since_RND_3) < 2 & as.numeric(years_since_RND_3) > -2 ) %>% group_by(Estado,RND_3) %>% summarise(tortura_f = mean(tortura_fis, na.rm = T)) 


National <- data_subset.df %>%
  ungroup() %>%
  summarise(
    across(
      ends_with("a"),
      ~mean(.x, na.rm = T)
    )
  ) %>%
  mutate(
    `Estado` = "Promedio Nacional"
  ) %>%
  mutate(
    across(
      ends_with("a"),
      list(b = ~rank(-.x)),
      .names = "{sub('a$', 'b', .col)}"
    )
  ) %>%
  mutate(
    across(
      ends_with("b"),
      ~case_when(
        .x == 1 ~ NA_real_
      )
    )
  )  %>% mutate(
    `15.1a`= (cambio_tort_f$tortura_f[2]-cambio_tort_f$tortura_f[1])/cambio_tort_f$tortura_f[1],
    `15.2a` =(cambio_tort_p$tortura_p[2]-cambio_tort_p$tortura_p[1])/cambio_tort_p$tortura_p[1])
